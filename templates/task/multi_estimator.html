{% extends "base.html" %}
{% block content %}


<div class="container" id = "container">
    <h5 class="my-3 border-bottom pb-2" id = "wrapper"> 종합 견적서 작성하기 </h5>
    <div class="card my-3">
        <div class="d-flex justify-content-end" style = "margin-right:20px;">
            <div class="card-body">
                <div class="card-text" style="white-space: pre-line;">내용 텟트</div>
            </div>        
            <div class="my-3">
                <a href="#" class="btn btn-sm btn-outline-secondary">수정</a>
                <a href="#" class="delete btn btn-sm btn-outline-secondary" data-uri="#">삭제</a>
            </div>
        </div>
    </div>



    <form method="post" class="post-form my-3" id = "form123">
        {{form.media}}
        {% csrf_token %}
        {% if form.errors %}
            <div class="alert alert-danger" role="alert">
            {% for field in form %}
                {% if field.errors %}
                <strong>{{ field.label }}</strong>
                {{ field.errors }}
                {% endif %}
            {% endfor %}
            </div>
        {% endif %}

        <span>  1) 모달 띄우기 - Done </span>
        <br>
        <span>  2) 일단은, closet을 ''보내놓고'', 선택에 따라 ajax로 변경. - Done  </span>
        <br>
        <span>  3) 만약 type이 바뀌면 기존 것은 삭제하고 새 것 추가 - Done </span>
        <br>
        <span>  4) 작성 버튼 클릭 시, 화면에 추가 - Done </span>
        <br>
        <span>  5) 수정 - 추가 필요, 삭제 - Done </span>
        <br>
        <span>  6) 종합 버튼 클릭 시, multi_estimator_create로 보냄 </span>
        <br>
        <span>  7) 각 estimator별로 model 작성, container도 작성 및 저장 </span>
        <br>


        <button type="button" id = "add-button" class="btn btn-info" style ="margin-bottom:10px;">추가 항목 작성 &nbsp;<span style="font-size:16px; font-weight:bold;">+ </span></button>
        <br>


        <button type="submit" id = "submit"  class="btn btn-primary">견적서 작성하기</button>
    <!-- modal 구동 버튼 (trigger) -->
<button type="button" class="btn btn-primary" data-toggle="modal" data-target="#modal">
  Modal 띄우기
</button>


<!-- Modal -->
<div class="modal fade" id="modal" role="dialog" aria-labelledby="myModalLabel">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                <h4 class="modal-title" id="myModalLabel">Modal 제목</h4>
            </div>
            <div class="modal-body">Modal 내용
                <form method="post" class="post-form my-3" id = "tttttt">
                    {{form.media}}
                    {% csrf_token %}
                    {% if form.errors %}
                        <div class="alert alert-danger" role="alert">
                        {% for field in form %}
                            {% if field.errors %}
                            <strong>{{ field.label }}</strong>
                            {{ field.errors }}
                            {% endif %}
                        {% endfor %}
                        </div>
                    {% endif %}

                    <div class="form-group" id = "type_div">
                        <label for="type">type</label>
                        <select class="form-control" name="type" id="type" aria-label=".form-select-lg example" required>
                            <option value= "" disabled selected hidden>type select</option>
                            {% for type in types%}
                            <option value= {{type.type}}>{{type.name}}</option>
                            {% endfor %}
                        </select>
                    </div>

                </form>
            </div>


            <div class="modal-footer">
                <button id = "submit-modal" type='button' class="btn btn-primary">제출하기</button>
                <button type="button" class="btn btn-default" data-dismiss="modal">닫기</button>
            </div>
        </div>
    </div>
</div>







{% endblock %}

{% block script %}

<script>
// type에 따른 modal form 갱신
// global variable
var container = $('#form123');
var estimator_count = 0;



$(document).ready(function(){
    var type = document.getElementById('type');

    type.addEventListener('change', function() {
        let val = type.value;
        let param = {'type' : val,
                    'csrfmiddlewaretoken': '{{ csrf_token }}'}

        console.log(val);

        $.ajax({
            url : "{% url 'task:estimator_add' %}",
            type : 'POST',
            datatype: 'json',
            data : param,

            success: function(data){

                // type의 부모 노드의 자식노드 (이전에 선택한 견적서 타입에 따라 추가한 form-group들)을 지움

                var type = $('#type_div');
                var children = type.parent().children('.form-group').not('#type_div').remove();


                // 받아온 데이터의 kwargs를 추가

                for (var i in data['kwargs']){
                    if (i != 'name'){
                        let kwarg = data['kwargs'][i];
                        var structure = '';

                        structure = structure + '<div class="form-group">' ;
                        structure = structure + '<label for="' + kwarg.text + '">' + kwarg.text + '</label>';
                        structure = structure + '<input id = "' + i  + '" type="' + kwarg.type + '" class="form-control" name="' + kwarg.text + '"rows="10" value="' + kwarg.value + '" min="' + kwarg.min + '" max="' + kwarg.max + '">';
                        structure = structure + '</div>'

                        structure = $(structure);

                        $(type).after(structure);
                        };

                    }
                },
            error : function(){
                console.log('error');
                }
            });
        });
    });





$(document).ready(function(){
    var modal_btn = document.getElementById('submit-modal');  //$('#submit-modal');
    var type = document.getElementById('type');


    modal_btn.addEventListener('click', function() {

        // form 식별해서 덮어쓰기가 안됨
        // 현재 작성중인 임시 견적서의 id를 알아야 함
        // 전역 변수로 지정
        // 신규작성의 경우, estimator_count에 해당하는 form이 없음
        // 수정의 경우, 반드시 있다. 
        estimator_count ++;

        console.log($('#'+estimator_count));
        // 만약 해당하는 요소가 있으면, 거기에 덮어 써라
        // 없으면 기존대로 신규작성


        var structure = '';

        structure = structure + '<div class="card my-3">';
        structure = structure + '<div class="d-flex justify-content-end" style = "margin-right:20px;">'
        structure = structure + '<div class="card-body">';
        structure = structure + '<div class="card-text" style="white-space: pre-line;">' + estimator_count +  '</div>';
        structure = structure + '</div>'
        structure = structure + '<div class="my-3">'
        structure = structure + '<a id = "delete' + estimator_count + '" href="#" class="btn btn-sm btn-outline-secondary modify" style = "margin-right:5px;" type="button" data-toggle="modal" data-target="#modal">수정</a>'
        structure = structure + '<a href="#" class="delete btn btn-sm btn-outline-secondary delete" data-uri="#">삭제</a>'
        structure = structure + '<form id="' + estimator_count + '" method="get">'

        $(modal_btn).parents(".modal-content").find("input[name!='csrfmiddlewaretoken']").not('#type_div').each(function(){
            structure = structure +  '<input hidden id="' + $(this).prop('id') + '" class = "' + $(this).prop('class') +'" value="' + $(this).val() + '" min = "' + $(this).prop('min') + '" max = "'+ $(this).prop('max') + '" name ="'+ $(this).prop('name') + '" type = "' + $(this).prop('type') + '">'
            });

        structure = structure + '</form>'
        structure = structure + '</div></div></div>'
        

        // 1) 모달 띄워서 hidden form 생성
        // 2) 수정하기 위해 정보를 갖고오기
        // 3) 근데 제출 이외의 방법으로 나가는 경우가 생김
        // 4) 이 경우에는 다시 hidden으로 돌리면 그만임
        // 즉, modal이 닫히는 이벤트를 작성해야 함
            
        


        structure = $(structure);

        $(container).before(structure);
        


        var delete_btn = structure.find('a.delete')[0];//document.getElementById('delete' + estimator_count); //structure.find('a.delete');
        var modify_btn = structure.find('a.modify')[0];

        delete_btn.addEventListener('click', function(){
            $(this).parents().eq(2).remove(); // 위로 2번째 element 삭제
            //estimator_count--;
            });

        modify_btn.addEventListener('click', function(){
            // load
            var values = $(modify_btn).parent('div').find('input');
            // modal form init
            var type_div = $('#type_div');
            type_div.parent().children('.form-group').not('#type_div').remove();
            // hidden form remove (id duplicate issue)
            //$(modify_btn).parent().children('form').remove();

            
            // add form-group
            for (var i = 0; i < values.length; i ++ ){

                var structure = '';

                var value = values[i]
                var name = $(values[i]).prop('name')
                structure = structure + '<div class="form-group">' ;
                structure = structure + '<label for="' + name + '">' + name + '</label>';
                structure = structure + value.outerHTML.replace('hidden', '');
                structure = structure + '</div>';
                
                structure = $(structure)
                
                type_div.after(structure);

                }

            });

        // 히든으로 남기는게 낫지 않을까? 

        var children = $(modal_btn).parents(".modal-content").find('input').not('#type_div').not('.csrfmiddlewaretoken');
        var form_dict = {};

        $(modal_btn).parents(".modal-content").find("input[name!='csrfmiddlewaretoken']").not('#type_div').each(function(){
            form_dict[ $(this).prop('id')] = $(this).val()
            });
        
          
        form_dict['csrfmiddlewaretoken'] = '{{ csrf_token }}'
        form_dict['type'] = type.value;

        $.ajax({
            url : "{% url 'task:estimator_create2' %}",
            type : 'POST',
            datatype: "json",
            data : form_dict,

            success: function(data){

                // 몰라몰라~
                // 1) 정보를 가져오는 것임. GET
                // 2) 그에 맞춰서 form을 세팅. 기존에 modal form의 요소 삭제 및 불러온 정보 추가, 값 세팅
                var modify_btn = structure.find('a.modify')[0];

                
                modify_btn.value =  data['id'];
                
                console.log('success');
                    
                },
            error : function(){
                console.log('error');
                }
            });

        // 안보이는 input으로 추가해놓기





        // 창 닫기
        $('#modal').modal('hide');



        });
    });


$(document).ready(function(){       
    $('#modal').on('hide.bs.modal', function () {
        var inputs = $(document).find('input').not('#modal');
        for (var i = 0; i < inputs.length; i ++ ){
            inputs[i].setAttribute("hidden", true);

            };

        });
 
    });


</script>
{% endblock %}


